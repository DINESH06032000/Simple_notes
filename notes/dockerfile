# ==============================
# Stage 1: Download dependencies
# ==============================
FROM maven:3.9.6-eclipse-temurin-17 AS deps
WORKDIR /app

# Copy only pom.xml first (so deps can be cached)
COPY pom.xml .

# Download all dependencies (cached unless pom.xml changes)
RUN mvn dependency:go-offline -B


# ==============================
# Stage 2: Build application
# ==============================
FROM maven:3.9.6-eclipse-temurin-17 AS build
WORKDIR /app

# Copy source code
COPY . .

# Copy cached dependencies
COPY --from=deps /root/.m2 /root/.m2

# Build the project (skip tests for faster builds)
RUN mvn clean package -DskipTests


# ==============================
# Stage 3: Runtime image (Railway-ready)
# ==============================
FROM eclipse-temurin:17-jdk-alpine
WORKDIR /app

# Copy the jar from build stage
COPY --from=build /app/target/*.jar app.jar

# Railway sets PORT env variable automatically
ENV PORT=8080

# Expose the port dynamically
EXPOSE ${PORT}

# Run the application with Railway's dynamic port
CMD ["sh", "-c", "java -jar app.jar --server.port=${PORT}"]
